// Generated by CoffeeScript 1.10.0
var NotificationsHelper, SocketHandler, emailsAppRessource, localization, log, logError, notificationsHelper;

NotificationsHelper = require('cozy-notifications-helper');

notificationsHelper = new NotificationsHelper('emails');

localization = require('./localization');

SocketHandler = require('./socket_handler');

log = require('./logging')({
  prefix: 'notifications'
});

emailsAppRessource = {
  app: 'emails',
  url: '/'
};

logError = function(err) {
  if (err) {
    return log.error("fail to create notif", err);
  }
};

exports.accountFirstImportComplete = function(account) {
  return localization.getPolyglot(function(err, t) {
    var text;
    text = t('notif complete', {
      account: account.label
    });
    return notificationsHelper.createTemporary({
      resource: emailsAppRessource,
      text: text
    }, logError);
  });
};

exports.accountRefreshed = function(account) {
  return localization.getPolyglot(function(err, t) {
    return account.totalUnread(function(err, totalUnread) {
      var accountID, data, message, ref;
      ref = "notif-unread-" + account.id;
      if (totalUnread === 0) {
        return notificationsHelper.destroy(ref);
      } else {
        message = t('notif new', {
          smart_count: totalUnread,
          account: account.label
        });
        accountID = account.id;
        data = {
          message: message,
          totalUnread: totalUnread,
          accountID: accountID
        };
        SocketHandler.notify('refresh.notify', data, logError);
        return notificationsHelper.createOrUpdatePersistent(ref, {
          resource: {
            app: 'emails',
            url: "/#account/" + accountID
          },
          text: message
        }, logError);
      }
    });
  });
};
