// Generated by CoffeeScript 1.9.0
var DOMParser, https;

https = require('https');

DOMParser = require('xmldom').DOMParser;

module.exports.get = function(req, res, next) {
  var url;
  url = "https://autoconfig.thunderbird.net/v1.1/" + req.params.domain;
  req = https.get(url, function(response) {
    var body;
    if (response.statusCode !== 200) {
      return res.status(response.statusCode).send('');
    } else {
      body = '';
      response.on('data', function(data) {
        return body += data;
      });
      return response.on('end', function() {
        var doc, getServers, getValue, infos, parseServer, provider, providers, _i, _len, _results;
        doc = new DOMParser().parseFromString(body);
        providers = doc.getElementsByTagName('emailProvider');
        infos = [];
        getValue = function(node, tag) {
          var nodes;
          nodes = node.getElementsByTagName(tag);
          if (nodes.length > 0) {
            return nodes[0].childNodes[0].nodeValue;
          }
        };
        parseServer = function(node) {
          var server;
          server = {
            type: node.getAttribute('type'),
            hostname: getValue(node, 'hostname'),
            port: getValue(node, 'port'),
            socketType: getValue(node, 'socketType')
          };
          return infos.push(server);
        };
        getServers = function(provider) {
          var server, servers, _i, _j, _len, _len1;
          servers = provider.getElementsByTagName('incomingServer');
          for (_i = 0, _len = servers.length; _i < _len; _i++) {
            server = servers[_i];
            parseServer(server);
          }
          servers = provider.getElementsByTagName('outgoingServer');
          for (_j = 0, _len1 = servers.length; _j < _len1; _j++) {
            server = servers[_j];
            parseServer(server);
          }
          return res.send(infos);
        };
        _results = [];
        for (_i = 0, _len = providers.length; _i < _len; _i++) {
          provider = providers[_i];
          _results.push(getServers(provider));
        }
        return _results;
      });
    }
  });
  return req.on('error', function(e) {
    return res.status(500).send({
      error: "Error getting provider infos : " + e.message
    });
  });
};
