// Generated by CoffeeScript 1.9.1
var BadRequest, Contact, ContactActivity, NotFound, async, log, ref;

Contact = require('../models/contact');

async = require('async');

log = require('../utils/logging')({
  prefix: 'controllers:activity'
});

ref = require('../utils/errors'), BadRequest = ref.BadRequest, NotFound = ref.NotFound;

ContactActivity = {
  search: function(data, callback) {
    var params, request;
    if (data.query != null) {
      request = 'mailByName';
      params = {
        startkey: data.query,
        endkey: data.query + "\uFFFF"
      };
    } else {
      request = 'all';
      params = {};
    }
    return Contact.requestWithPictures(request, params, callback);
  },
  create: function(data, callback) {
    var ref1;
    if (((ref1 = data.contact) != null ? ref1.address : void 0) != null) {
      return Contact.createNoDuplicate(data.contact, callback);
    } else {
      return callback(new BadRequest('BAD FORMAT'));
    }
  },
  "delete": function(data, callback) {
    return Contact.find(data.id, function(err, contact) {
      if (err) {
        return callback(err);
      }
      if (!contact) {
        return callback(new NotFound("CONTACT " + data.id));
      }
      return contact.destroy(callback);
    });
  }
};

module.exports.create = function(req, res, next) {
  var activity, ref1;
  activity = req.body;
  switch (activity.data.type) {
    case 'contact':
      if (ContactActivity[activity.name] != null) {
        return ContactActivity[activity.name](activity.data, function(err, result) {
          if (err != null) {
            return res.status(400).send({
              name: err.message,
              error: true
            });
          } else {
            return res.send({
              result: result
            });
          }
        });
      } else {
        return res.status(400).send({
          name: "Unknown activity name",
          error: true
        });
      }
      break;
    case 'error':
      log.error(activity.data);
      log.error((ref1 = activity.data.error) != null ? ref1.stack : void 0);
      return res.send('ok');
    case 'debug':
      log.info(activity.data.message);
      return res.send('ok');
    default:
      return res.status(400).send({
        name: "Unknown activity data type",
        error: true
      });
  }
};
