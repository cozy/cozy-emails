// Generated by CoffeeScript 1.10.0
var EventEmitter, Logger, Process, _, log, uuid;

_ = require('lodash');

uuid = require('uuid');

Logger = require('../utils/logging');

log = Logger('imap:reporter');

EventEmitter = require('events').EventEmitter;

module.exports = Process = (function() {
  function Process(options) {
    this.errors = [];
    this.options = options;
    this.id = this.code + uuid.v4();
    log.debug("constructor process " + this.id);
  }

  Process.prototype.initialize = function() {
    throw new Error('initialize should be overriden by process subclass');
  };

  Process.prototype.summary = function() {
    return {
      id: this.id,
      finished: this.finished,
      done: this.getProgress(),
      total: 1,
      errors: this.errors,
      box: this.box,
      account: this.account,
      code: this.code,
      objectID: this.objectID,
      firstImport: this.firstImport
    };
  };

  Process.prototype.clone = function() {
    return new this.constructor(this.options);
  };

  Process.prototype.getProgress = function() {
    return 0.5;
  };

  Process.prototype.abort = function(callback) {
    return this.aborted = true;
  };

  Process.prototype.addCallback = function(callback) {
    if (this.callbacks == null) {
      this.callbacks = [];
    }
    return this.callbacks.push(callback);
  };

  Process.prototype.run = function(callback) {
    log.debug("run process " + this.id);
    this.addCallback(callback);
    return this.initialize(this.options, (function(_this) {
      return function(err, arg1, arg2, arg3, arg4) {
        var cb, i, len, ref, results;
        ref = _this.callbacks;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          cb = ref[i];
          results.push(typeof cb === "function" ? cb(err, arg1, arg2, arg3, arg4) : void 0);
        }
        return results;
      };
    })(this));
  };

  Process.prototype.onError = function(err) {
    this.errors.push(Logger.getLasts() + "\n" + err.stack);
    return log.error("reporter err", err.stack);
  };

  return Process;

})();
