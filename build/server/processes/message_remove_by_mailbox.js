// Generated by CoffeeScript 1.9.0
var CONCURRENT_DESTROY, ERRORMSG, LIMIT_UPDATE, MAX_RETRIES, Message, Process, RemoveAllMessagesFromMailbox, async, log, _ref,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  __hasProp = {}.hasOwnProperty,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

ERRORMSG = "DS has crashed ? waiting 4s before try again";

_ref = require('../utils/constants'), MAX_RETRIES = _ref.MAX_RETRIES, CONCURRENT_DESTROY = _ref.CONCURRENT_DESTROY, LIMIT_UPDATE = _ref.LIMIT_UPDATE;

Process = require('./_base');

async = require('async');

Message = require('../models/message');

log = require('../utils/logging')('process:removebymailbox');

module.exports = RemoveAllMessagesFromMailbox = (function(_super) {
  __extends(RemoveAllMessagesFromMailbox, _super);

  function RemoveAllMessagesFromMailbox() {
    this.destroyMessages = __bind(this.destroyMessages, this);
    this.shouldDestroy = __bind(this.shouldDestroy, this);
    this.fetchMessages = __bind(this.fetchMessages, this);
    this.step = __bind(this.step, this);
    this.notFinished = __bind(this.notFinished, this);
    return RemoveAllMessagesFromMailbox.__super__.constructor.apply(this, arguments);
  }

  RemoveAllMessagesFromMailbox.prototype.code = 'remove-all-from-box';

  RemoveAllMessagesFromMailbox.prototype.initialize = function(options, callback) {
    this.mailboxID = options.mailboxID;
    this.toDestroyMailboxIDs = options.toDestroyMailboxIDs || [];
    this.retries = MAX_RETRIES;
    this.batch;
    return async.doWhilst(this.step, this.notFinished, callback);
  };

  RemoveAllMessagesFromMailbox.prototype.notFinished = function() {
    return this.batch.length > 0;
  };

  RemoveAllMessagesFromMailbox.prototype.step = function(callback) {
    return this.fetchMessages((function(_this) {
      return function(err) {
        if (err) {
          return callback(err);
        }
        if (_this.batch.length === 0) {
          return callback(null);
        }
        return _this.destroyMessages(function(err) {
          if (err && _this.retries > 0) {
            log.warn(ERRORMSG, err);
            _this.retries--;
            return setTimeout(callback, 4000);
          } else if (err) {
            return callback(err);
          } else {
            _this.retries = MAX_RETRIES;
            return callback(null);
          }
        });
      };
    })(this));
  };

  RemoveAllMessagesFromMailbox.prototype.fetchMessages = function(callback) {
    return Message.rawRequest('byMailboxRequest', {
      limit: LIMIT_UPDATE,
      startkey: ['uid', this.mailboxID, 0],
      endkey: ['uid', this.mailboxID, {}],
      include_docs: true,
      reduce: false
    }, (function(_this) {
      return function(err, rows) {
        if (err) {
          return callback(err);
        }
        _this.batch = rows.map(function(row) {
          return new Message(row.doc);
        });
        return callback(null);
      };
    })(this));
  };

  RemoveAllMessagesFromMailbox.prototype.shouldDestroy = function(message) {
    var boxID, uid, _ref1;
    _ref1 = message.mailboxIDs;
    for (boxID in _ref1) {
      uid = _ref1[boxID];
      if (__indexOf.call(this.toDestroyMailboxIDs, boxID) < 0) {
        return false;
      }
    }
    return true;
  };

  RemoveAllMessagesFromMailbox.prototype.destroyMessages = function(callback) {
    return async.eachLimit(this.batch, CONCURRENT_DESTROY, (function(_this) {
      return function(message, cb) {
        if (_this.shouldDestroy(message)) {
          return message.destroy(cb);
        } else {
          return message.removeFromMailbox({
            id: _this.mailboxID
          }, false, cb);
        }
      };
    })(this), callback);
  };

  return RemoveAllMessagesFromMailbox;

})(Process);
